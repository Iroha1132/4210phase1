<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Product Details</title>
      <link rel="stylesheet" href="/styles/main.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
   </head>
   <body>
      <header>
         <h1>Dummy Shopping Website</h1>
         <nav>
            <ul>
               <li><a href="/">Home</a></li>
               <li><a href="#">Categories</a></li>
               <li><a href="#">About</a></li>
               <li><a href="/admin" id="admin-link" style="display: none;">Admin</a></li>
               <li><a href="/orders" id="orders-link" style="display: none;">My Orders</a></li>
               <li>
                  <form id="logout-form" method="POST" action="/logout"><button type="submit" id="logout-link" style="display: none;">Logout</button></form>
               </li>
            </ul>
         </nav>
         <button id="user-status" class="user-status">Guest</button>
         <button id="cart-button" class="cart-button">Cart (0)</button>
      </header>
      <section class="breadcrumb">
         <p><a href="/">Home</a> > <a href="/" id="breadcrumb-category">All Categories</a> > <span id="breadcrumb-product">Product</span></p>
      </section>
      <section class="product-details" id="product-details"></section>
      <div class="back-link">
         <a href="/">Back to Products</a>
      </div>
      <div id="shopping-cart" class="shopping-cart">
         <button class="close-cart">Ã—</button>
         <h3>Shopping Cart</h3>
         <ul class="cart-items"></ul>
      </div>
      <!-- Chatbox -->
      <div id="chatbox" class="chatbox" style="display: none;">
         <button id="chat-button" class="chat-button">ðŸ’¬</button>
         <div id="chat-window" class="chat-window">
            <div class="chat-header">
               <span>Customer Support</span>
               <button id="chat-close" class="close-chat">Ã—</button>
            </div>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="chat-input">
               <input type="text" id="message-input" placeholder="Type your message...">
               <button id="send-message">Send</button>
            </div>
         </div>
      </div>
      <footer>
         <p>Â© 2025 Dummy Shopping Website</p>
      </footer>
      <script src="/cart.js"></script>
      <script>
         document.addEventListener('DOMContentLoaded', () => {
             // Handle CSRF token
             let csrfToken;
             fetch('https://ierg4210.eastasia.cloudapp.azure.com/csrf-token', { credentials: 'include' })
                 .then(res => res.json())
                 .then(data => {
                     csrfToken = data.csrfToken;
                     const logoutForm = document.getElementById('logout-form');
                     logoutForm.insertAdjacentHTML('afterbegin', `<input type="hidden" name="csrfToken" value="${csrfToken}">`);
                     
                     logoutForm.addEventListener('submit', async (e) => {
                         e.preventDefault();
                         const button = logoutForm.querySelector('button[type="submit"]');
                         button.disabled = true;
                         try {
                             const response = await fetch('https://ierg4210.eastasia.cloudapp.azure.com/logout', {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json',
                                     'X-CSRF-Token': csrfToken
                                 },
                                 credentials: 'include'
                             });
                             if (!response.ok) throw new Error('Logout failed');
                             const result = await response.json();
                             if (result.csrfToken) {
                                 document.querySelector('#logout-form input[name="csrfToken"]').value = result.csrfToken;
                             }
                             window.location.href = result.redirect || '/login';
                         } catch (err) {
                             console.error('Logout error:', err);
                             fetch('https://ierg4210.eastasia.cloudapp.azure.com/csrf-token', { credentials: 'include' })
                                 .then(res => res.json())
                                 .then(data => {
                                     document.querySelector('#logout-form input[name="csrfToken"]').value = data.csrfToken;
                                     window.location.href = '/login';
                                 });
                         } finally {
                             button.disabled = false;
                         }
                     });
                 })
                 .catch(err => console.error('CSRF fetch error:', err));
         
             // Handle user status and chatbox visibility
             fetch('https://ierg4210.eastasia.cloudapp.azure.com/user', { credentials: 'include' })
                 .then(res => res.json())
                 .then(data => {
                     const userStatus = document.getElementById('user-status');
                     const logoutLink = document.getElementById('logout-link');
                     const adminLink = document.getElementById('admin-link');
                     const ordersLink = document.getElementById('orders-link');
                     const chatbox = document.getElementById('chatbox');
                     
                     if (data.email !== 'Guest') {
                         userStatus.textContent = 'Logout';
                         logoutLink.style.display = 'inline';
                         userStatus.style.display = 'none';
                         ordersLink.style.display = 'inline';
                         chatbox.style.display = 'block'; // Show chatbox for logged-in users
                         initChat(csrfToken); // Initialize chat functionality
                         if (data.isAdmin && adminLink) {
                             adminLink.style.display = 'inline';
                         } else if (adminLink) {
                             adminLink.style.display = 'none';
                         }
                     } else {
                         userStatus.textContent = 'Login';
                         userStatus.style.display = 'inline';
                         logoutLink.style.display = 'none';
                         ordersLink.style.display = 'none';
                         chatbox.style.display = 'none'; // Hide chatbox for guests
                         if (adminLink) {
                             adminLink.style.display = 'none';
                         }
                         userStatus.onclick = () => window.location.href = '/login';
                     }
                 })
                 .catch(err => console.error('User fetch error:', err));
         
             // Initialize chat functionality
             function initChat(csrfToken) {
                 const chatButton = document.getElementById('chat-button');
                 const chatWindow = document.getElementById('chat-window');
                 const chatClose = document.getElementById('chat-close');
                 const sendButton = document.getElementById('send-message');
                 const messageInput = document.getElementById('message-input');
                 const chatMessages = document.getElementById('chat-messages');
         
                 chatButton.addEventListener('click', () => {
                     chatWindow.classList.toggle('visible');
                 });
                 chatClose.addEventListener('click', () => {
                     chatWindow.classList.remove('visible');
                 });
         
                 sendButton.addEventListener('click', async () => {
                     const content = messageInput.value.trim();
                     if (!content) return;
                     try {
                         const response = await fetch('https://ierg4210.eastasia.cloudapp.azure.com/send-message', {
                             method: 'POST',
                             headers: {
                                 'Content-Type': 'application/json',
                                 'X-CSRF-Token': csrfToken
                             },
                             body: JSON.stringify({ content }),
                             credentials: 'include'
                         });
                         const data = await response.json();
                         if (data.success) {
                             messageInput.value = '';
                             fetchMessages();
                         } else {
                             alert('Error sending message: ' + data.error);
                         }
                     } catch (err) {
                         console.error('Send message error:', err);
                         alert('Error sending message');
                     }
                 });
         
                 async function fetchMessages() {
                     try {
                         const response = await fetch('https://ierg4210.eastasia.cloudapp.azure.com/messages', { credentials: 'include' });
                         const messages = await response.json();
                         chatMessages.innerHTML = '';
                         messages.forEach(msg => {
                             const div = document.createElement('div');
                             div.className = msg.admin_reply ? 'message admin-message' : 'message user-message';
                             div.innerHTML = DOMPurify.sanitize(
                                 msg.admin_reply ? `<span>Support: ${msg.admin_reply}</span>` : `<span>You: ${msg.content}</span>`
                             );
                             chatMessages.appendChild(div);
                         });
                         chatMessages.scrollTop = chatMessages.scrollHeight;
                     } catch (err) {
                         console.error('Fetch messages error:', err);
                     }
                 }
         
                 setInterval(fetchMessages, 5000); // Poll every 5 seconds
                 fetchMessages(); // Initial fetch
             }
         
             // Load product details
             const urlParams = new URLSearchParams(window.location.search);
             const pid = urlParams.get('pid');
             if (pid) {
                 fetch(`https://ierg4210.eastasia.cloudapp.azure.com/product/${pid}`)
                     .then(response => {
                         if (!response.ok) throw new Error('Product fetch failed');
                         return response.json();
                     })
                     .then(product => {
                         document.getElementById('breadcrumb-product').textContent = product.name;
                         document.getElementById('breadcrumb-category').textContent = product.category_name;
                         document.getElementById('breadcrumb-category').href = `/?catid=${product.catid}`;
                         const productDetails = document.getElementById('product-details');
                         productDetails.innerHTML = DOMPurify.sanitize(`
                             <div class="product-image-container">
                                 <img src="${product.image || '/images/product' + product.pid + '.jpg'}" alt="${product.name}" class="product-image">
                             </div>
                             <div class="product-info">
                                 <h2>${product.name}</h2>
                                 <p class="price">$${product.price}</p>
                                 <p class="description">${product.description}</p>
                                 <button class="add-to-cart" data-pid="${product.pid}" data-name="${product.name}" data-price="${product.price}">Add to Cart</button>
                             </div>
                         `);
                     })
                     .catch(err => console.error('Product fetch error:', err));
             } else {
                 document.getElementById('product-details').innerHTML = '<p>Product not found</p>';
             }
         });
      </script>
      <!-- Existing Cloudflare scripts -->
      <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9353ca292addb0e8',t:'MTc0NTQ3ODcxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
      <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'935462d63ca2676e',t:'MTc0NTQ4NDk3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
      <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93d857515c75b0af',t:'MTc0Njg2ODYyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
   </body>
</html>