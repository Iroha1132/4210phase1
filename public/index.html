<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Dummy Shopping Website</title>
      <link rel="stylesheet" href="/styles/main.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
   </head>
   <body>
      <header>
         <h1>Dummy Shopping Website</h1>
         <nav>
            <ul>
               <li><a href="/">Home</a></li>
               <li><a href="#">Categories</a></li>
               <li><a href="#">About</a></li>
               <li><a href="/register">Register</a></li>
               <li><a href="/login">Login</a></li>
               <li><a href="/admin" id="admin-link" style="display: none;">Admin</a></li>
               <li><a href="/orders" id="orders-link" style="display: none;">My Orders</a></li>
               <li>
                  <form id="logout-form" method="POST" action="/logout"><button type="submit" id="logout-link" style="display: none;">Logout</button></form>
               </li>
            </ul>
         </nav>
         <button id="user-status" class="user-status">Guest</button>
         <button id="cart-button" class="cart-button">Cart (0)</button>
      </header>
      <section class="breadcrumb">
         <p><a href="/">Home</a> > <span id="breadcrumb-category">All Categories</span></p>
      </section>
      <section class="category-select">
         <label for="category-select">Select Category:</label>
         <select id="category-select">
            <option value="">-- Select a Category --</option>
         </select>
      </section>
      <section class="product-list" id="product-list"></section>
      <div id="shopping-cart" class="shopping-cart">
         <button class="close-cart">×</button>
         <h3>Shopping Cart</h3>
         <ul class="cart-items"></ul>
      </div>
      <footer>
         <p>© 2025 Dummy Shopping Website</p>
      </footer>
      <script src="/cart.js"></script>
      <script>
         document.addEventListener('DOMContentLoaded', () => {
             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/csrf-token', { credentials: 'include' })
                 .then(res => res.json())
                 .then(data => {
                     const logoutForm = document.getElementById('logout-form');
                     logoutForm.insertAdjacentHTML('afterbegin', `<input type="hidden" name="csrfToken" value="${data.csrfToken}">`);
                     
                     logoutForm.addEventListener('submit', async (e) => {
                         e.preventDefault();
                         const button = logoutForm.querySelector('button[type="submit"]');
                         button.disabled = true;
                         
                         try {
                             const response = await fetch('https://ierg4210.koreacentral.cloudapp.azure.com/logout', {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json',
                                     'X-CSRF-Token': data.csrfToken
                                 },
                                 credentials: 'include'
                             });
                             
                             if (!response.ok) throw new Error('Logout failed');
                             
                             const result = await response.json();
                             if (result.csrfToken) {
                                 document.querySelector('#logout-form input[name="csrfToken"]').value = result.csrfToken;
                             }
                             window.location.href = result.redirect || '/login';
                         } catch (err) {
                             console.error('Logout error:', err);
                             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/csrf-token', { credentials: 'include' })
                                 .then(res => res.json())
                                 .then(data => {
                                     document.querySelector('#logout-form input[name="csrfToken"]').value = data.csrfToken;
                                     window.location.href = '/login';
                                 });
                         } finally {
                             button.disabled = false;
                         }
                     });
                 })
                 .catch(err => console.error('CSRF fetch error:', err));
         
             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/user', { credentials: 'include' })
                 .then(res => res.json())
                 .then(data => {
                     const userStatus = document.getElementById('user-status');
                     const logoutLink = document.getElementById('logout-link');
                     const adminLink = document.getElementById('admin-link');
                     const ordersLink = document.getElementById('orders-link');
                     
                     if (data.email !== 'Guest') {
                         userStatus.textContent = 'Logout';
                         logoutLink.style.display = 'inline';
                         userStatus.style.display = 'none';
                         ordersLink.style.display = 'inline';
                         
                         if (data.isAdmin && adminLink) {
                             adminLink.style.display = 'inline';
                         } else if (adminLink) {
                             adminLink.style.display = 'none';
                         }
                     } else {
                         userStatus.textContent = 'Login';
                         userStatus.style.display = 'inline';
                         logoutLink.style.display = 'none';
                         ordersLink.style.display = 'none';
                         if (adminLink) {
                             adminLink.style.display = 'none';
                         }
                         userStatus.onclick = () => window.location.href = '/login';
                     }
                 })
                 .catch(err => console.error('User fetch error:', err));
         
             if (document.getElementById('category-select')) {
                 fetch('https://ierg4210.koreacentral.cloudapp.azure.com/categories')
                     .then(response => {
                         if (!response.ok) throw new Error('Categories fetch failed');
                         return response.json();
                     })
                     .then(categories => {
                         const categorySelect = document.getElementById('category-select');
                         categories.forEach(category => {
                             const option = document.createElement('option');
                             option.value = category.catid;
                             option.textContent = category.name;
                             categorySelect.appendChild(option);
                         });
         
                         const urlParams = new URLSearchParams(window.location.search);
                         const catid = urlParams.get('catid');
                         if (catid) {
                             categorySelect.value = catid;
                             loadProducts(catid);
                             document.getElementById('breadcrumb-category').textContent = categorySelect.options[categorySelect.selectedIndex].text;
                         } else {
                             loadProducts();
                         }
                     })
                     .catch(err => console.error('Categories error:', err));
             }
         
             function loadProducts(catid = null) {
                 const url = catid ? `https://ierg4210.koreacentral.cloudapp.azure.com/products/${catid}` : 'https://ierg4210.koreacentral.cloudapp.azure.com/products';
                 fetch(url)
                     .then(response => {
                         if (!response.ok) throw new Error('Products fetch failed');
                         return response.json();
                     })
                     .then(products => {
                         const productList = document.getElementById('product-list');
                         productList.innerHTML = '';
                         products.forEach(product => {
                             const productDiv = document.createElement('div');
                             productDiv.className = 'product';
                             productDiv.innerHTML = DOMPurify.sanitize(`
                                 <a href="/product?pid=${product.pid}">
                                     <img src="${product.thumbnail || '/images/product' + product.pid + '.jpg'}" alt="${product.name}" class="thumbnail">
                                     <h3>${product.name}</h3>
                                 </a>
                                 <p>$${product.price}</p>
                                 <button class="add-to-cart" data-pid="${product.pid}" data-name="${product.name}" data-price="${product.price}">Add to Cart</button>
                             `);
                             productList.appendChild(productDiv);
                         });
                     })
                     .catch(err => console.error('Products error:', err));
             }
         
             document.getElementById('category-select').addEventListener('change', (e) => {
                 const catid = e.target.value;
                 if (catid) {
                     history.pushState({}, '', `?catid=${catid}`);
                     loadProducts(catid);
                     document.getElementById('breadcrumb-category').textContent = e.target.options[e.target.selectedIndex].text;
                 } else {
                     history.pushState({}, '', '/');
                     loadProducts();
                     document.getElementById('breadcrumb-category').textContent = 'All Categories';
                 }
             });
         });
      </script>
   </body>
</html>