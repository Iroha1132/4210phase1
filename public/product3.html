<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product 3 - Dummy Shopping Website</title>
    <link rel="stylesheet" href="css/styles.css" />
    <script>
      // Redirect to HTTPS if not already
      if (
        window.location.protocol !== "https:" &&
        window.location.hostname !== "localhost"
      ) {
        window.location.href =
          "https:" +
          window.location.href.substring(window.location.protocol.length);
      }
    </script>
  </head>

  <body>
    <header>
      <h1>Dummy Shopping Website</h1>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="#">Category 1</a></li>
          <li><a href="#">Category 2</a></li>
        </ul>
      </nav>
      <div id="user-status" class="user-status">
        <span id="user-email">Guest</span>
      </div>
    </header>

    <main>
      <section class="breadcrumb">
        <p><a href="index.html">Home</a> / Product 3</p>
      </section>

      <section class="product-details">
        <img src="images/product3.jpg" alt="Product 3" />
        <h2>Product 3</h2>
        <p>Price: $39.99</p>
        <p>Description: Product 3 offers unmatched durability and style.</p>
        <button
          class="add-to-cart"
          data-pid="3"
          data-name="Product 3"
          data-price="39.99"
        >
          Add to Cart
        </button>
      </section>

      <section class="shopping-list">
        <h2>Shopping List</h2>
        <form id="paypal-form" action="https://www.sandbox.paypal.com/cgi-bin/webscr" method="post">
          <input type="hidden" name="cmd" value="_cart">
          <input type="hidden" name="upload" value="1">
          <input type="hidden" name="business" value="your-paypal-email@example.com">
          <input type="hidden" name="charset" value="utf-8">
          <input type="hidden" name="currency_code" value="USD">
          <input type="hidden" name="invoice" id="invoice">
          <input type="hidden" name="custom" id="custom">
          <input type="hidden" id="csrf-token" name="_csrf">
          <div class="cart-items" id="cart-items">
            <!-- 动态生成购物车项目 -->
          </div>
          <button type="submit" class="checkout">Checkout with PayPal</button>
        </form>
      </section>
    </main>

    <footer>
      <p>© 2024 Dummy Shopping Website</p>
    </footer>

    <script>
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      // 获取 CSRF 令牌
      fetch("/csrf-token", { credentials: "include" })
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("csrf-token").value = data.csrfToken;
        });

      // 添加购物车功能
      document.addEventListener("click", (event) => {
        if (event.target.classList.contains("add-to-cart")) {
          const productId = event.target.getAttribute("data-pid");
          const productName = event.target.getAttribute("data-name");
          const productPrice = event.target.getAttribute("data-price");

          let cart = JSON.parse(localStorage.getItem("cart")) || [];
          const existingProduct = cart.find((item) => item.pid === productId);

          if (existingProduct) {
            existingProduct.quantity += 1;
          } else {
            cart.push({
              pid: productId,
              name: productName,
              price: productPrice,
              quantity: 1,
            });
          }

          localStorage.setItem("cart", JSON.stringify(cart));
          updateCartUI();
        }
      });

      // 更新购物车 UI
      function updateCartUI() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const cartItems = document.getElementById("cart-items");
        cartItems.innerHTML = "";

        let totalAmount = 0;
        cart.forEach((item, index) => {
          totalAmount += item.price * item.quantity;
          const cartItem = document.createElement("div");
          cartItem.className = "cart-item";
          cartItem.innerHTML = `
            <input type="hidden" name="item_name_${index + 1}" value="${item.name}">
            <input type="hidden" name="item_number_${index + 1}" value="${item.pid}">
            <input type="hidden" name="quantity_${index + 1}" value="${item.quantity}">
            <input type="hidden" name="amount_${index + 1}" value="${item.price}">
            <input type="number" value="${item.quantity}" min="1" data-pid="${item.pid}">
            <span>${item.name} - $${item.price}</span>
            <button class="remove-item" data-pid="${item.pid}">Remove</button>
          `;
          cartItems.appendChild(cartItem);
        });

        const totalElement = document.createElement("div");
        totalElement.className = "total";
        totalElement.innerHTML = `Total: $${totalAmount.toFixed(2)}`;
        cartItems.appendChild(totalElement);
      }

      // 删除购物车中的商品
      document.addEventListener("click", (event) => {
        if (event.target.classList.contains("remove-item")) {
          const pid = event.target.getAttribute("data-pid");
          let cart = JSON.parse(localStorage.getItem("cart")) || [];
          cart = cart.filter((item) => item.pid !== pid);
          localStorage.setItem("cart", JSON.stringify(cart));
          updateCartUI();
        }
      });

      // 更新购物车数量
      document.addEventListener("change", (event) => {
        if (event.target.type === "number" && event.target.parentElement.classList.contains("cart-item")) {
          const pid = event.target.getAttribute("data-pid");
          const newQuantity = parseInt(event.target.value);
          let cart = JSON.parse(localStorage.getItem("cart")) || [];
          const item = cart.find((item) => item.pid === pid);
          if (item && newQuantity > 0) {
            item.quantity = newQuantity;
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartUI();
          }
        }
      });

      // 结账按钮点击事件
      document.getElementById("paypal-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        if (cart.length === 0) {
          alert("Your cart is empty!");
          return;
        }

        const items = cart.map((item) => ({
          pid: item.pid,
          quantity: item.quantity,
        }));

        fetch("/validate-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.getElementById("csrf-token").value,
          },
          credentials: "include",
          body: JSON.stringify({ items }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("invoice").value = data.orderId;
              document.getElementById("custom").value = data.digest;
              localStorage.removeItem("cart");
              updateCartUI();
              document.getElementById("paypal-form").submit();
            } else {
              alert("Order validation failed: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error during order validation");
          });
      });

      function checkUserStatus() {
        fetch("/user-info", {
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("Not logged in");
          })
          .then((data) => {
            const userStatusElement = document.getElementById("user-status");
            if (data.email) {
              document.getElementById("user-email").textContent = data.email;
              if (data.isAdmin) {
                const adminLink = document.createElement("a");
                adminLink.href = "/admin.html";
                adminLink.textContent = " (Admin)";
                adminLink.style.marginLeft = "5px";
                userStatusElement.appendChild(adminLink);
              }
            } else {
              document.getElementById("user-email").textContent = "Guest";
            }
          })
          .catch(() => {
            document.getElementById("user-email").textContent = "Guest";
          });
      }

      document.getElementById("user-status").addEventListener("click", (e) => {
        if (e.target.tagName === "A") return;
        fetch("/user-info", {
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("Not logged in");
          })
          .then((data) => {
            if (data.email) {
              window.location.href = "/user-dashboard.html";
            } else {
              window.location.href = "/login.html";
            }
          })
          .catch(() => {
            window.location.href = "/login.html";
          });
      });

      window.addEventListener("load", () => {
        checkUserStatus();
        updateCartUI();
      });
    </script>
  </body>
</html>