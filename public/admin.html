<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      .error {
        color: red;
        font-size: 0.9em;
      }

      ul {
        list-style-type: none;
        padding: 0;
      }

      li {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      button {
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
      }

      button.delete {
        background-color: #ff4d4d;
      }

      button.delete:hover {
        background-color: #cc0000;
      }

      button.edit {
        background-color: #4caf50;
        margin-right: 5px;
      }

      button.edit:hover {
        background-color: #45a049;
      }

      form {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      label {
        display: block;
        margin: 10px 0 5px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .form-section {
        margin-bottom: 30px;
      }

      .logout-btn {
        background-color: #555;
        padding: 8px 15px;
        float: right;
      }

      #product-submit-btn {
        background-color: #4caf50;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      #category-submit-btn {
        background-color: #2196f3;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      #change-password-form button[type="submit"] {
        background-color: #ff9800;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      #product-submit-btn:hover,
      #category-submit-btn:hover,
      #change-password-form button[type="submit"]:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .order-details {
        margin-left: 20px;
      }
    </style>
  </head>

  <body>
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h1>Admin Panel</h1>

    <div class="form-section">
      <h2>Change Password</h2>
      <form id="change-password-form">
        <input type="hidden" id="csrf-token-pw" name="_csrf" />
        <label for="current-password">Current Password:</label>
        <input
          type="password"
          id="current-password"
          name="current-password"
          required
        />
        <label for="new-password">New Password:</label>
        <input
          type="password"
          id="new-password"
          name="new-password"
          required
          minlength="8"
        />
        <label for="confirm-password">Confirm New Password:</label>
        <input
          type="password"
          id="confirm-password"
          name="confirm-password"
          required
          minlength="8"
        />
        <button type="submit">Change Password</button>
      </form>
    </div>

    <div class="form-section">
      <form id="product-form">
        <h2>Manage Products</h2>
        <input type="hidden" id="csrf-token-product" name="_csrf" />
        <input type="hidden" id="product-id" name="pid" />
        <label for="category">Category:</label>
        <select id="category" name="catid" required>
          <option value="">-- Select a Category --</option>
        </select>
        <label for="name">Product Name:</label>
        <input type="text" id="name" name="name" required maxlength="100" />
        <label for="price">Price:</label>
        <input
          type="number"
          id="price"
          name="price"
          step="0.01"
          min="0"
          required
        />
        <label for="description">Description:</label>
        <textarea
          id="description"
          name="description"
          required
          maxlength="500"
        ></textarea>
        <label for="image">Product Image:</label>
        <input
          type="file"
          id="image"
          name="image"
          accept="image/jpeg, image/png, image/gif"
        />
        <div id="image-error" class="error"></div>
        <button type="submit" id="product-submit-btn">Add Product</button>
      </form>
    </div>

    <div class="form-section">
      <form id="category-form">
        <h2>Manage Categories</h2>
        <input type="hidden" id="csrf-token-category" name="_csrf" />
        <input type="hidden" id="category-id" name="category-id" />
        <label for="category-name">Category Name:</label>
        <input
          type="text"
          id="category-name"
          name="category-name"
          required
          maxlength="50"
        />
        <button type="submit" id="category-submit-btn">Add Category</button>
      </form>
    </div>

    <div class="form-section">
      <h2>Product List</h2>
      <ul id="product-list"></ul>
    </div>

    <div class="form-section">
      <h2>Category List</h2>
      <ul id="category-list"></ul>
    </div>

    <div class="form-section">
      <h2>Order List</h2>
      <ul id="order-list"></ul>
    </div>

    <script>
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      function checkAuth() {
        fetch("/check-auth", {
          credentials: "include",
        })
          .then((response) => {
            if (!response.ok) throw new Error("Not authenticated");
            return response.json();
          })
          .then((data) => {
            fetch("/check-admin", { credentials: "include" })
              .then((res) => res.json())
              .then((adminData) => {
                if (!adminData.isAdmin) {
                  window.location.href = "/user-dashboard.html";
                } else {
                  loadCategories();
                  loadProducts();
                  loadCategoryList();
                  loadOrders();
                  fetch("/csrf-token", { credentials: "include" })
                    .then((res) => res.json())
                    .then((data) => {
                      document.getElementById("csrf-token-pw").value =
                        data.csrfToken;
                      document.getElementById("csrf-token-product").value =
                        data.csrfToken;
                      document.getElementById("csrf-token-category").value =
                        data.csrfToken;
                    });
                }
              });
          })
          .catch(() => {
            window.location.href = "/login.html";
          });
      }

      window.addEventListener("load", () => {
        checkAuth();
      });

      function logout() {
        fetch("/logout", {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": getCookie("XSRF-TOKEN"),
          },
        }).then(() => {
          window.location.href = "/login.html";
        });
      }

      function loadCategories() {
        fetch("/categories", {
          credentials: "include",
        })
          .then((response) => response.json())
          .then((categories) => {
            const categorySelect = document.getElementById("category");
            categorySelect.innerHTML =
              '<option value="">-- Select a Category --</option>';
            categories.forEach((category) => {
              const option = document.createElement("option");
              option.value = category.catid;
              option.textContent = category.name;
              categorySelect.appendChild(option);
            });
          });
      }

      function loadProducts() {
        fetch("/products", {
          credentials: "include",
        })
          .then((response) => response.json())
          .then((products) => {
            const productList = document.getElementById("product-list");
            productList.innerHTML = "";
            products.forEach((product) => {
              const li = document.createElement("li");
              li.innerHTML = `
                ${product.name} - $${product.price}
                <div>
                  <button class="edit" onclick="editProduct(${product.pid})">Edit</button>
                  <button class="delete" onclick="deleteProduct(${product.pid})">Delete</button>
                </div>
              `;
              productList.appendChild(li);
            });
          });
      }

      function loadCategoryList() {
        fetch("/categories", {
          credentials: "include",
        })
          .then((response) => response.json())
          .then((categories) => {
            const categoryList = document.getElementById("category-list");
            categoryList.innerHTML = "";
            categories.forEach((category) => {
              const li = document.createElement("li");
              li.innerHTML = `
                ${category.name}
                <div>
                  <button class="edit" onclick="editCategory(${category.catid})">Edit</button>
                  <button class="delete" onclick="deleteCategory(${category.catid})">Delete</button>
                </div>
              `;
              categoryList.appendChild(li);
            });
          });
      }

      function loadOrders() {
        fetch("/admin-orders", {
          credentials: "include",
        })
          .then((response) => response.json())
          .then((orders) => {
            const orderList = document.getElementById("order-list");
            orderList.innerHTML = "";
            orders.forEach((order) => {
              const li = document.createElement("li");
              li.innerHTML = `
                Order #${order.orderId} by ${order.username} - $${order.totalPrice} (${order.status})
                <div class="order-details">
                  <ul>
                    ${order.items.map((item) => `<li>${item.name} - ${item.quantity} x $${item.price}</li>`).join("")}
                  </ul>
                </div>
              `;
              orderList.appendChild(li);
            });
          });
      }

      document
        .getElementById("change-password-form")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const currentPassword =
            document.getElementById("current-password").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;
          const csrfToken = document.getElementById("csrf-token-pw").value;

          if (newPassword !== confirmPassword) {
            alert("New passwords do not match");
            return;
          }

          fetch("/change-password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken,
            },
            credentials: "include",
            body: JSON.stringify({ currentPassword, newPassword }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert("Password changed successfully");
                window.location.href = "/login.html";
              } else {
                alert(data.message || "Failed to change password");
              }
            })
            .catch((error) => console.error("Error:", error));
        });

      document
        .getElementById("product-form")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const productId = document.getElementById("product-id").value;
          const csrfToken = document.getElementById("csrf-token-product").value;

          const imageFile = document.getElementById("image").files[0];
          if (imageFile && imageFile.size > 10 * 1024 * 1024) {
            document.getElementById("image-error").textContent =
              "Image size must be less than 10MB.";
            return;
          } else {
            document.getElementById("image-error").textContent = "";
          }

          const url = productId
            ? `/update-product/${productId}`
            : "/add-product";
          const method = productId ? "PUT" : "POST";

          fetch(url, {
            method: method,
            headers: {
              "X-CSRF-Token": csrfToken,
            },
            credentials: "include",
            body: formData,
          })
            .then((response) => response.text())
            .then((message) => {
              alert(message);
              loadProducts();
              document.getElementById("product-form").reset();
              document.getElementById("product-id").value = "";
              document.getElementById("product-submit-btn").textContent =
                "Add Product";
            })
            .catch((error) => console.error("Error:", error));
        });

      document
        .getElementById("category-form")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const categoryId = document.getElementById("category-id").value;
          const categoryName = document.getElementById("category-name").value;
          const csrfToken = document.getElementById(
            "csrf-token-category"
          ).value;

          const url = categoryId
            ? `/update-category/${categoryId}`
            : "/add-category";
          const method = categoryId ? "PUT" : "POST";

          fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken,
            },
            credentials: "include",
            body: JSON.stringify({ name: categoryName }),
          })
            .then((response) => response.text())
            .then((message) => {
              alert(message);
              loadCategories();
              loadCategoryList();
              document.getElementById("category-form").reset();
              document.getElementById("category-id").value = "";
              document.getElementById("category-submit-btn").textContent =
                "Add Category";
            })
            .catch((error) => console.error("Error:", error));
        });

      function editProduct(pid) {
        fetch(`/product/${pid}`, {
          credentials: "include",
        })
          .then((response) => response.json())
          .then((product) => {
            document.getElementById("product-id").value = product.pid;
            document.getElementById("category").value = product.catid;
            document.getElementById("name").value = product.name;
            document.getElementById("price").value = product.price;
            document.getElementById("description").value = product.description;
            document.getElementById("product-submit-btn").textContent =
              "Update Product";
          });
      }

      function editCategory(catid) {
        fetch(`/category/${catid}`, {
          credentials: "include",
        })
          .then((response) => response.json())
          .then((category) => {
            document.getElementById("category-id").value = category.catid;
            document.getElementById("category-name").value = category.name;
            document.getElementById("category-submit-btn").textContent =
              "Update Category";
          });
      }

      function deleteProduct(pid) {
        if (confirm("Are you sure you want to delete this product?")) {
          fetch(`/delete-product/${pid}`, {
            method: "DELETE",
            headers: {
              "X-CSRF-Token": getCookie("XSRF-TOKEN"),
            },
            credentials: "include",
          })
            .then((response) => response.text())
            .then((message) => {
              alert(message);
              loadProducts();
            })
            .catch((error) => console.error("Error:", error));
        }
      }

      function deleteCategory(catid) {
        if (confirm("Are you sure you want to delete this category?")) {
          fetch(`/delete-category/${catid}`, {
            method: "DELETE",
            headers: {
              "X-CSRF-Token": getCookie("XSRF-TOKEN"),
            },
            credentials: "include",
          })
            .then((response) => response.text())
            .then((message) => {
              alert(message);
              loadCategories();
              loadCategoryList();
            })
            .catch((error) => console.error("Error:", error));
        }
      }
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9346a4743cee4570',t:'MTc0NTM0MDg1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  </body>
</html>